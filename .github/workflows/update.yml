name: Update Docker Offline Packages

on:
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨ 2 ç‚¹
  workflow_dispatch:
    inputs:
      architectures:
        description: 'æ¶æ„é€‰æ‹©'
        default: 'all'
        type: choice
        options: [all, x86_64, aarch64]
  push:
    branches: [main, master]
    paths:
      - 'packages/scripts/**'
      - 'packages/services/**'
      - '.github/workflows/update.yml'

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # æ˜ç¡®å£°æ˜æƒé™
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä¾¿äºç‰ˆæœ¬æ¯”è¾ƒ
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: æ£€æŸ¥æ›´æ–°
        id: check
        run: |
          # æ£€æŸ¥ VERSION.json æ˜¯å¦å­˜åœ¨
          if [ -f "packages/VERSION.json" ]; then
            CURRENT=$(python3 -c "import json; print(json.load(open('packages/VERSION.json'))['docker_version'])" 2>/dev/null || echo "none")
          else
            CURRENT="none"
            echo "âš ï¸ VERSION.json ä¸å­˜åœ¨ï¼Œè¿™å¯èƒ½æ˜¯é¦–æ¬¡è¿è¡Œ"
          fi
          
          # è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œå¢åŠ é”™è¯¯å¤„ç†
          LATEST=$(curl -s --fail https://api.github.com/repos/moby/moby/releases/latest | \
                   python3 -c "import sys,json,re; data=json.load(sys.stdin); print(re.search(r'\d+\.\d+\.\d+', data['tag_name']).group())" 2>/dev/null || echo "error")
          
          if [ "$LATEST" = "error" ]; then
            echo "âŒ è·å–æœ€æ–°ç‰ˆæœ¬å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ– API é™åˆ¶"
            exit 1
          fi
          
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT"
          echo "æœ€æ–°ç‰ˆæœ¬: $LATEST"
          
          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest_version=$LATEST" >> $GITHUB_OUTPUT
          
          # åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "need_update=true" >> $GITHUB_OUTPUT
            echo "âœ… éœ€è¦æ›´æ–°åˆ° $LATEST"
          else
            echo "need_update=false" >> $GITHUB_OUTPUT
            echo "âœ… å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
          fi
      
      - name: ä¸‹è½½æ›´æ–°
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        run: |
          ARCH=${{ github.event.inputs.architectures || 'all' }}
          echo "å¼€å§‹ä¸‹è½½æ¶æ„: $ARCH"
          python3 packages/scripts/update.py -o packages -a $ARCH --ci
      
      - name: è¯»å–ç‰ˆæœ¬
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        id: version
        run: |
          if [ ! -f "packages/VERSION.json" ]; then
            echo "âŒ VERSION.json ä¸å­˜åœ¨ï¼Œä¸‹è½½å¯èƒ½å¤±è´¥"
            exit 1
          fi
          
          DOCKER_VER=$(python3 -c "import json; print(json.load(open('packages/VERSION.json'))['docker_version'])")
          COMPOSE_VER=$(python3 -c "import json; print(json.load(open('packages/VERSION.json'))['compose_version'])")
          
          echo "docker=$DOCKER_VER" >> $GITHUB_OUTPUT
          echo "compose=$COMPOSE_VER" >> $GITHUB_OUTPUT
          echo "Docker: $DOCKER_VER, Compose: $COMPOSE_VER"
      
      - name: æ‰“åŒ…
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        id: package
        run: |
          NAME="docker-offline-v${{ steps.version.outputs.docker }}"
          echo "åˆ›å»ºå‘å¸ƒåŒ…: $NAME"
          
          mkdir -p "release/$NAME/packages"
          
          cp -r packages/* "release/$NAME/packages/"
          cp README.md "release/$NAME/"
          
          cd release
          tar -czf "$NAME.tar.gz" "$NAME"
          sha256sum "$NAME.tar.gz" > "$NAME.tar.gz.sha256"
          
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "file=$NAME.tar.gz" >> $GITHUB_OUTPUT
          echo "âœ… æ‰“åŒ…å®Œæˆ"
      
      - name: æäº¤ä»£ç 
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/
          
          if git diff --staged --quiet; then
            echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            git commit -m "chore: update to Docker v${{ steps.version.outputs.docker }}"
            git push
            echo "âœ… ä»£ç å·²æäº¤"
          fi
          
          # åˆ›å»º tag
          TAG="v${{ steps.version.outputs.docker }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            git tag -a "$TAG" -m "Docker v${{ steps.version.outputs.docker }}"
            git push origin "$TAG"
            echo "âœ… Tag $TAG å·²åˆ›å»º"
          fi
      
      - name: åˆ›å»º Release
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.docker }}
          name: Docker v${{ steps.version.outputs.docker }}
          body: |
            **Docker**: `${{ steps.version.outputs.docker }}`
            **Compose**: `${{ steps.version.outputs.compose }}`
            
            ## ğŸ“¥ å®‰è£…è¯´æ˜
            
            ```bash
            # ä¸‹è½½ç¦»çº¿åŒ…
            wget https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.docker }}/${{ steps.package.outputs.file }}
            
            # éªŒè¯æ ¡éªŒå’Œï¼ˆå¯é€‰ï¼‰
            wget https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.docker }}/${{ steps.package.outputs.file }}.sha256
            sha256sum -c ${{ steps.package.outputs.file }}.sha256
            
            # è§£å‹å¹¶å®‰è£…
            tar -xzf ${{ steps.package.outputs.file }}
            cd ${{ steps.package.outputs.name }}
            sudo bash packages/scripts/install.sh
            ```
            
            ## ğŸ“¦ åŒ…å«å†…å®¹
            - Docker Engine v${{ steps.version.outputs.docker }}
            - Docker Compose v${{ steps.version.outputs.compose }}
            - æ”¯æŒæ¶æ„: x86_64, aarch64
          files: |
            release/${{ steps.package.outputs.file }}
            release/${{ steps.package.outputs.file }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}