name: Update Docker Offline Packages

on:
  schedule:
    - cron: '0 2 * * 1'  # æ¯å‘¨ä¸€å‡Œæ™¨ 2 ç‚¹
  workflow_dispatch:
    inputs:
      architectures:
        description: 'æ¶æ„é€‰æ‹©'
        default: 'all'
        type: choice
        options: [all, x86_64, aarch64]
  push:
    branches: [main, master]
    paths:
      - 'packages/scripts/**'
      - 'packages/services/**'
      - '.github/workflows/update.yml'

env:
  GITHUB_CONTEXT: ${{ toJson(github) }}

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
    
    outputs:
      need_update: ${{ steps.check.outputs.need_update }}
      docker_version: ${{ steps.version.outputs.docker }}
      compose_version: ${{ steps.version.outputs.compose }}
      release_name: ${{ steps.package.outputs.name }}
      release_file: ${{ steps.package.outputs.file }}
    
    steps:
      - name: 'ğŸ“¥ æ£€å‡ºä»£ç '
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: 'ğŸ è®¾ç½® Python ç¯å¢ƒ'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 'ğŸ” ç‰ˆæœ¬æ£€æŸ¥'
        id: check
        run: |
          echo "::group::ğŸ“Š ç‰ˆæœ¬å¯¹æ¯”"
          
          # æ£€æŸ¥æœ¬åœ°ç‰ˆæœ¬
          if [ -f "packages/VERSION.json" ]; then
            CURRENT=$(python3 -c "import json; print(json.load(open('packages/VERSION.json'))['docker_version'])" 2>/dev/null || echo "none")
            echo "âœ“ æ‰¾åˆ°æœ¬åœ° VERSION.json"
          else
            CURRENT="none"
            echo "âš ï¸  WARNING: VERSION.json ä¸å­˜åœ¨ï¼Œè¿™å¯èƒ½æ˜¯é¦–æ¬¡è¿è¡Œ"
          fi
          
          # è·å–æœ€æ–°ç‰ˆæœ¬
          echo "æ­£åœ¨è·å–æœ€æ–°ç‰ˆæœ¬..."
          LATEST=$(curl -s --fail \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/moby/moby/releases/latest | \
            python3 -c "import sys,json,re; data=json.load(sys.stdin); print(re.search(r'\d+\.\d+\.\d+', data['tag_name']).group())" 2>/dev/null || echo "error")
          
          if [ "$LATEST" = "error" ]; then
            echo "::error::âŒ è·å–æœ€æ–°ç‰ˆæœ¬å¤±è´¥ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ– API é™åˆ¶"
            exit 1
          fi
          
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT"
          echo "æœ€æ–°ç‰ˆæœ¬: $LATEST"
          
          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest_version=$LATEST" >> $GITHUB_OUTPUT
          
          # åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
          if [ "$CURRENT" != "$LATEST" ]; then
            echo "need_update=true" >> $GITHUB_OUTPUT
            echo "::notice::âœ“ éœ€è¦æ›´æ–°åˆ° $LATEST"
          else
            echo "need_update=false" >> $GITHUB_OUTPUT
            echo "âœ“ å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
          fi
          
          echo "::endgroup::"
      
      - name: 'ğŸ“¥ ä¸‹è½½æ›´æ–°åŒ…'
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        run: |
          echo "::group::â¬‡ï¸ ä¸‹è½½ Docker ç¦»çº¿åŒ…"
          
          ARCH="${{ github.event.inputs.architectures || 'all' }}"
          echo "æ¶æ„é€‰æ‹©: $ARCH"
          echo ""
          
          python3 packages/scripts/update.py -o packages -a $ARCH --ci
          
          echo ""
          echo "::endgroup::"
      
      - name: 'ğŸ“– è¯»å–ç‰ˆæœ¬ä¿¡æ¯'
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        id: version
        run: |
          echo "::group::ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯"
          
          if [ ! -f "packages/VERSION.json" ]; then
            echo "::error::âŒ VERSION.json ä¸å­˜åœ¨ï¼Œä¸‹è½½å¯èƒ½å¤±è´¥"
            exit 1
          fi
          
          DOCKER_VER=$(python3 -c "import json; print(json.load(open('packages/VERSION.json'))['docker_version'])")
          COMPOSE_VER=$(python3 -c "import json; print(json.load(open('packages/VERSION.json'))['compose_version'])")
          
          echo "Docker ç‰ˆæœ¬: $DOCKER_VER"
          echo "Compose ç‰ˆæœ¬: $COMPOSE_VER"
          
          echo "docker=$DOCKER_VER" >> $GITHUB_OUTPUT
          echo "compose=$COMPOSE_VER" >> $GITHUB_OUTPUT
          
          echo "::endgroup::"
      
      - name: 'ğŸ“Š ç»Ÿè®¡æ–‡ä»¶ä¿¡æ¯'
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        run: |
          echo "::group::ğŸ“¦ åŒ…æ–‡ä»¶ç»Ÿè®¡"
          
          cd packages
          
          echo "Docker äºŒè¿›åˆ¶åŒ…:"
          ls -lh docker-*.tgz 2>/dev/null | awk '{print "  â€¢ " $9 " (" $5 ")"}'
          
          echo ""
          echo "Docker Compose:"
          ls -lh docker-compose-linux-* 2>/dev/null | grep -v '.tgz' | awk '{print "  â€¢ " $9 " (" $5 ")"}'
          
          echo ""
          echo "Rootless Extras:"
          ls -lh docker-rootless-extras-*.tgz 2>/dev/null | awk '{print "  â€¢ " $9 " (" $5 ")"}'
          
          echo ""
          echo "æ ¡éªŒä¿¡æ¯:"
          if [ -f "SHA256SUMS" ]; then
            echo "  âœ“ SHA256SUMS å·²ç”Ÿæˆ"
            wc -l < SHA256SUMS | awk '{print "  â€¢ åŒ…å« " $1 " ä¸ªæ–‡ä»¶"}'
          fi
          
          if [ -f "VERSION.json" ]; then
            echo "  âœ“ VERSION.json å·²ç”Ÿæˆ"
          fi
          
          echo "::endgroup::"
      
      - name: 'ğŸ æ‰“åŒ…å‘å¸ƒç‰ˆæœ¬'
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        id: package
        run: |
          echo "::group::ğŸ“¦ æ‰“åŒ…å‘å¸ƒç‰ˆæœ¬"
          
          DOCKER_VER="${{ steps.version.outputs.docker }}"
          NAME="docker-offline-v${DOCKER_VER}"
          
          echo "å‘å¸ƒåŒ…åç§°: $NAME"
          echo ""
          
          # åˆ›å»ºå‘å¸ƒç›®å½•ç»“æ„
          mkdir -p "release/$NAME/packages"
          echo "âœ“ åˆ›å»ºç›®å½•ç»“æ„"
          
          # å¤åˆ¶æ–‡ä»¶
          cp -r packages/* "release/$NAME/packages/" 2>/dev/null && echo "âœ“ å¤åˆ¶ Docker åŒ…æ–‡ä»¶"
          cp README.md "release/$NAME/" 2>/dev/null && echo "âœ“ å¤åˆ¶ README"
          
          # æ‰“åŒ…
          cd release
          echo ""
          echo "æ­£åœ¨å‹ç¼©..."
          tar -czf "$NAME.tar.gz" "$NAME" && echo "âœ“ åˆ›å»º TAR.GZ åŒ…"
          
          # è®¡ç®—æ ¡éªŒå’Œ
          sha256sum "$NAME.tar.gz" > "$NAME.tar.gz.sha256" && echo "âœ“ ç”Ÿæˆ SHA256 æ ¡éªŒå’Œ"
          
          # ç»Ÿè®¡å¤§å°
          SIZE=$(du -h "$NAME.tar.gz" | awk '{print $1}')
          echo ""
          echo "å‘å¸ƒåŒ…å¤§å°: $SIZE"
          
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "file=$NAME.tar.gz" >> $GITHUB_OUTPUT
          
          echo "::endgroup::"
      
      - name: 'ğŸ’¾ æäº¤ä»£ç å˜æ›´'
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        run: |
          echo "::group::ğŸ“ Git æ“ä½œ"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add packages/
          
          if git diff --staged --quiet; then
            echo "âš ï¸  WARNING: æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
          else
            DOCKER_VER="${{ steps.version.outputs.docker }}"
            git commit -m "chore: update Docker offline packages to v${DOCKER_VER}"
            git push
            echo "âœ“ ä»£ç å˜æ›´å·²æäº¤å¹¶æ¨é€"
          fi
          
          echo ""
          echo "æ­£åœ¨åˆ›å»º Git Tag..."
          
          # åˆ›å»º tag
          TAG="v${{ steps.version.outputs.docker }}"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "âš ï¸  WARNING: Tag $TAG å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            git tag -a "$TAG" -m "Docker v${{ steps.version.outputs.docker }} - Offline Installation Package"
            git push origin "$TAG"
            echo "âœ“ Tag $TAG å·²åˆ›å»ºå¹¶æ¨é€"
          fi
          
          echo "::endgroup::"
      
      - name: 'ğŸš€ å‘å¸ƒ Release'
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.docker }}
          name: 'Docker Offline Package v${{ steps.version.outputs.docker }}'
          draft: false
          prerelease: false
          body: |
            # ğŸ³ Docker ç¦»çº¿å®‰è£…åŒ…
            
            **Docker Engine**: `${{ steps.version.outputs.docker }}`  
            **Docker Compose**: `${{ steps.version.outputs.compose }}`
            
            ## ğŸ“‹ æ”¯æŒæ¶æ„
            
            - âœ“ x86_64 (AMD64)
            - âœ“ aarch64 (ARM64)
            
            ## ğŸ“¥ å¿«é€Ÿå¼€å§‹
            
            ### 1ï¸âƒ£ ä¸‹è½½
            
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.docker }}/${{ steps.package.outputs.file }}
            ```
            
            ### 2ï¸âƒ£ éªŒè¯ (å¯é€‰)
            
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.docker }}/${{ steps.package.outputs.file }}.sha256
            sha256sum -c ${{ steps.package.outputs.file }}.sha256
            ```
            
            ### 3ï¸âƒ£ å®‰è£…
            
            ```bash
            tar -xzf ${{ steps.package.outputs.file }}
            cd ${{ steps.package.outputs.name }}
            sudo bash packages/scripts/install.sh
            ```
            
            ## ğŸ—‘ï¸ å¸è½½
            
            ```bash
            cd ${{ steps.package.outputs.name }}
            sudo bash packages/scripts/uninstall.sh
            ```
            
            ## ğŸ“¦ åŒ…å«å†…å®¹
            
            - âœ… Docker Engine v${{ steps.version.outputs.docker }}
            - âœ… Docker Compose v${{ steps.version.outputs.compose }}
            - âœ… containerd å’Œ runc
            - âœ… å®Œæ•´çš„å®‰è£…å’Œå¸è½½è„šæœ¬
            - âœ… systemd æœåŠ¡é…ç½®
            
            ## ğŸ” å®‰å…¨éªŒè¯
            
            æ‰€æœ‰å‘å¸ƒåŒ…éƒ½åŒ…å« SHA256 æ ¡éªŒå’Œï¼Œå»ºè®®éªŒè¯å®Œæ•´æ€§åå†ä½¿ç”¨ã€‚
            
            ---
            
            **å‘å¸ƒæ—¶é—´**: ${{ github.event.head_commit.timestamp }}  
            **è§¦å‘äº‹ä»¶**: ${{ github.event_name }}
          files: |
            release/${{ steps.package.outputs.file }}
            release/${{ steps.package.outputs.file }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 'âœ… å·¥ä½œæµå®Œæˆ'
        if: always()
        run: |
          echo "::group::ğŸ“Š å·¥ä½œæµæ€»ç»“"
          
          if [ "${{ steps.check.outputs.need_update }}" = "true" ]; then
            echo "âœ“ æˆåŠŸæ›´æ–°åˆ° Docker v${{ steps.version.outputs.docker }}"
            echo "âœ“ å‘å¸ƒåŒ…: ${{ steps.package.outputs.file }}"
          else
            echo "â„¹ï¸  æ— éœ€æ›´æ–°ï¼ˆå·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼‰"
          fi
          
          echo ""
          echo "å·¥ä½œæµçŠ¶æ€: ${{ job.status }}"
          
          echo "::endgroup::"