name: Update Docker Offline Packages

on:
  schedule:
    - cron: '0 2 * * 1'  # 每周一凌晨 2 点
  workflow_dispatch:
    inputs:
      architectures:
        description: '架构选择'
        default: 'all'
        type: choice
        options: [all, x86_64, aarch64]
  push:
    tags: ['update-packages-*']

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 检查更新
        id: check
        run: |
          CURRENT=$(python3 -c "import json; print(json.load(open('packages/VERSION.json'))['docker_version'])" 2>/dev/null || echo "none")
          LATEST=$(curl -s https://api.github.com/repos/moby/moby/releases/latest | python3 -c "import sys,json,re; print(re.search(r'\d+\.\d+\.\d+', json.load(sys.stdin)['tag_name']).group())")
          
          echo "current_version=$CURRENT" >> $GITHUB_OUTPUT
          echo "latest_version=$LATEST" >> $GITHUB_OUTPUT
          echo "need_update=$([[ "$CURRENT" != "$LATEST" ]] && echo true || echo false)" >> $GITHUB_OUTPUT
      
      - name: 下载更新
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          ARCH=${{ github.event.inputs.architectures || 'all' }}
          python3 scripts/update.py -o packages -a $ARCH --ci
      
      - name: 读取版本
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch'
        id: version
        run: |
          VERSION=$(python3 -c "import json; d=json.load(open('packages/VERSION.json')); print(d['docker_version']); print(d['compose_version'])")
          echo "docker=$(echo $VERSION | awk 'NR==1')" >> $GITHUB_OUTPUT
          echo "compose=$(echo $VERSION | awk 'NR==2')" >> $GITHUB_OUTPUT
      
      - name: 打包
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch'
        id: package
        run: |
          NAME="docker-offline-v${{ steps.version.outputs.docker }}"
          mkdir -p "release/$NAME/packages"
          
          cp -r packages/* "release/$NAME/packages/"
          cp -r scripts "release/$NAME/packages/"
          cp -r services "release/$NAME/packages/"
          cp README.md "release/$NAME/"
          
          cd release
          tar -czf "$NAME.tar.gz" "$NAME"
          sha256sum "$NAME.tar.gz" > "$NAME.tar.gz.sha256"
          
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "file=$NAME.tar.gz" >> $GITHUB_OUTPUT
      
      - name: 提交
        if: steps.check.outputs.need_update == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packages/
          git diff --staged --quiet || (git commit -m "chore: update to v${{ steps.version.outputs.docker }}" && git push)
      
      - name: 发布
        if: steps.check.outputs.need_update == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.docker }}
          name: Docker v${{ steps.version.outputs.docker }}
          body: |
            **Docker**: `${{ steps.version.outputs.docker }}`
            **Compose**: `${{ steps.version.outputs.compose }}`
            
            ```bash
            wget https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.docker }}/${{ steps.package.outputs.file }}
            tar -xzf ${{ steps.package.outputs.file }}
            cd ${{ steps.package.outputs.name }}
            sudo bash packages/scripts/install.sh
            ```
          files: |
            release/${{ steps.package.outputs.file }}
            release/${{ steps.package.outputs.file }}.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 清理
        if: always()
        run: rm -rf release/